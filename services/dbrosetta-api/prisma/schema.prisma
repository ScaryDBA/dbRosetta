// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Dialect {
  id                     Int            @id @default(autoincrement())
  name                   String         @unique @db.VarChar(50)
  displayName            String         @map("display_name") @db.VarChar(100)
  version                String?        @db.VarChar(20)
  description            String?
  isActive               Boolean        @default(true) @map("is_active")
  metadata               Json?
  createdAt              DateTime       @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt              DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()
  
  // Relations
  translations           Translation[]
  sourceArtifacts        Artifact[]     @relation("SourceDialect")
  targetArtifacts        Artifact[]     @relation("TargetDialect")

  @@index([name], name: "idx_dialects_name")
  @@index([isActive], name: "idx_dialects_active")
  @@index([metadata], type: Gin, name: "idx_dialects_metadata")
  @@map("dialects")
  @@schema("dbrosetta")
}

model Term {
  id                     Int            @id @default(autoincrement())
  canonicalTerm          String         @map("canonical_term") @db.VarChar(200)
  category               String         @db.VarChar(50)
  subcategory            String?        @db.VarChar(50)
  description            String
  usageContext           String?        @map("usage_context")
  isActive               Boolean        @default(true) @map("is_active")
  metadata               Json?
  createdAt              DateTime       @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt              DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  // Relations
  translations           Translation[]

  @@index([canonicalTerm], name: "idx_terms_canonical")
  @@index([category], name: "idx_terms_category")
  @@index([category, subcategory], name: "idx_terms_category_sub")
  @@index([isActive], name: "idx_terms_active")
  @@index([metadata], type: Gin, name: "idx_terms_metadata")
  @@map("terms")
  @@schema("dbrosetta")
}

model Translation {
  id                     BigInt         @id @default(autoincrement())
  termId                 Int            @map("term_id")
  dialectId              Int            @map("dialect_id")
  translatedTerm         String         @map("translated_term")
  syntaxPattern          String?        @map("syntax_pattern")
  examples               String?
  notes                  String?
  confidenceLevel        Int            @default(100) @map("confidence_level")
  isActive               Boolean        @default(true) @map("is_active")
  metadata               Json?
  createdAt              DateTime       @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt              DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  // Relations
  term                   Term           @relation(fields: [termId], references: [id], onDelete: Cascade)
  dialect                Dialect        @relation(fields: [dialectId], references: [id], onDelete: Cascade)

  @@unique([termId, dialectId], name: "uq_translations_term_dialect")
  @@index([termId], name: "idx_translations_term")
  @@index([dialectId], name: "idx_translations_dialect")
  @@index([isActive], name: "idx_translations_active")
  @@index([confidenceLevel], name: "idx_translations_confidence")
  @@index([metadata], type: Gin, name: "idx_translations_metadata")
  @@map("translations")
  @@schema("dbrosetta")
}

model Artifact {
  id                     BigInt         @id @default(autoincrement())
  name                   String         @db.VarChar(200)
  artifactType           String         @map("artifact_type") @db.VarChar(50)
  sourceDialectId        Int?           @map("source_dialect_id")
  targetDialectId        Int?           @map("target_dialect_id")
  originalSql            String?        @map("original_sql")
  translatedSql          String?        @map("translated_sql")
  translationSummary     String?        @map("translation_summary")
  status                 String         @default("draft") @db.VarChar(20)
  metadata               Json?
  createdAt              DateTime       @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt              DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()

  // Relations
  sourceDialect          Dialect?       @relation("SourceDialect", fields: [sourceDialectId], references: [id], onDelete: SetNull)
  targetDialect          Dialect?       @relation("TargetDialect", fields: [targetDialectId], references: [id], onDelete: SetNull)

  @@index([name], name: "idx_artifacts_name")
  @@index([artifactType], name: "idx_artifacts_type")
  @@index([sourceDialectId], name: "idx_artifacts_source_dialect")
  @@index([targetDialectId], name: "idx_artifacts_target_dialect")
  @@index([status], name: "idx_artifacts_status")
  @@index([createdAt], name: "idx_artifacts_created")
  @@index([metadata], type: Gin, name: "idx_artifacts_metadata")
  @@map("artifacts")
  @@schema("dbrosetta")
}
